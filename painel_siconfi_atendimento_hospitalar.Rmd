---
title: "Deslocamentos e gastos hospitalares dos municípios"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    source_code: https://github.com/tchiluanda/siconfi_atendimento_hospitalar
runtime: shiny
---
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PK2407NCVV"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-PK2407NCVV');
</script>



```{css}
    .chart-shim {
      overflow: auto;
    }

```



```{css}
<meta name="author" content="Tesoro Nacional">
<meta name="description" content="A diversidade de possibilidades de atendimentos hospitalares nos municípios brasileiros levam a fluxos de pacientes entre municípios brasileiros? A alocação de recursos municipais em hospitais traz influências nesse eventual fluxo? O painel e o texto que a equipe de dados da STN desenvolveu indica que sim para ambas perguntas">
<meta property="og:image" content="https://github.com/fernandobarbalho/enap_auto_instucional/blob/main/wilker-lauriano-9dkdy9m0YXE-unsplash.jpg">
<meta property="og:description" content="Entenda os fluxos de pacientes hospitalares entre municípios brasileiros e suas relações com as despesas públicas">
<meta property="og:title" content="Internações hospitalares e deslocamentos">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="
Internações hospitalares e deslocamentos
">
<meta name="twitter:description" content="Entenda os fluxos de pacientes hospitalares entre municípios brasileiros e suas relações com as despesas públicas.">
<meta name="twitter:site" content="@TesouroNacional">
<meta name="twitter:creator" content="@barbalhofernand">
<meta name="twitter:image" content="https://github.com/fernandobarbalho/enap_auto_instucional/blob/main/wilker-lauriano-9dkdy9m0YXE-unsplash.jpg">

```


```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(tidyverse)
library(geobr)
library(readxl)
library(basedosdados)
library(viridis)
library(sf)
library(ggrepel)
library(colorspace)
library(patchwork)
library(parcats)
library(plotly)
library(DT)
library(readr)
library(easyalluvial)


###Dados
 regioes_saude <- readRDS("regioes_saude.RDS")

dataset_analise <- readRDS("dataset_analise_2021.RDS")

dataset_analise$munuf<- paste(dataset_analise$mun_res_nome.x,dataset_analise$uf.x,sep = "-")


#Subsititui o valor do gasto percentual de Brasília pelo gasto percentual do DF
#O gasto percentual do DF é calculado a partir de planilha montada com dados trazidoso do MEU SICONFI
#Referência ano 2021, para gastos liquidados

perc_brasilia_DF<- 6.734319894

dataset_analise<-
  dataset_analise %>%
  mutate(perc.x = ifelse(munic_res=="530010", perc_brasilia_DF, perc.x),
         perc.y = ifelse(codufmun =="530010", perc_brasilia_DF, perc.y ))
  
  
# dataset_analise %>%
#   mutate(perc.x = ifelse(cod_cidade.x=="5300108", perc_brasilia_DF, perc.x),
#          perc.y = ifelse(cod_cidade.y =="5300108", perc_brasilia_DF, perc.y ))


agrupamento_municipio_cluster<-readRDS("agrupamento_municipio_2021.RDS")

load("dados_auxiliares.RData")

# dataset_analise<-
# dataset_analise %>%
#   inner_join(
#     pop_municipios %>%
#       select(id_municipio,
#              sigla_uf) 
#   ) %>%
#   mutate(uf.x = sigla_uf,
#          uf.y = sigla_uf) %>%
#   select(-sigla_uf)

de_para_hierarquia <- read_delim("de_para_hierarquia.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)


pop_municipios$pop_cut<- cut(pop_municipios$populacao, 
                             breaks = c(0,
                                        2000,
                                        5000,
                                        10000,
                                        20000,
                                        50000,
                                        100000,
                                        500000,
                                        max(pop_municipios$populacao)), 
                             labels= c("0-2.000",
                                       "2.001-5.000",
                                       "5.000-10.000",
                                       "10.001-20.000",
                                       "20.001-50.000",
                                       "50.001-100.000",
                                       "100.001-500.000",
                                       ">500.000"))

municipios_seat<- cbind(municipios_seat, st_coordinates(st_centroid(municipios_seat)))

municipios_seat<-
municipios_seat %>%
  inner_join(
    pop_municipios %>%
      mutate(code_muni=  as.numeric(id_municipio)) %>%
      select(code_muni, populacao, pop_cut)
  )





REGIC_trabalho$nome_nivel_hierarquia_ordenado<-
factor(REGIC_trabalho$nome_nivel_hierarquia, levels = unique(REGIC_trabalho$nome_nivel_hierarquia[order(REGIC_trabalho$nivel_hierarquia)]))


agrupamento_municipio<-
    dataset_analise %>%
      filter(
             deslocamento ==1) %>%
      group_by(munic_res) %>%
      summarise(
        numero_internacoes = n()
      ) %>%
      mutate(code_muni = munic_res,
             tipo_deslocamento = "saida" ) %>%
      bind_rows(
        dataset_analise %>%
          filter(
                 deslocamento ==1) %>%
          group_by(codufmun) %>%
          summarise(
            numero_internacoes = n()
          ) %>%
          mutate(code_muni = codufmun,
                 tipo_deslocamento = "entrada"),
        dataset_analise %>%
          filter(
                 deslocamento ==0) %>%
          group_by(codufmun) %>%
          summarise(
            numero_internacoes = n()
          ) %>%
          mutate(code_muni = codufmun,
                 tipo_deslocamento = "local")
      ) %>%
  group_by(code_muni, tipo_deslocamento) %>%
  summarise(
    total_internacoes = sum(numero_internacoes)
  ) %>%
  ungroup()

agrupamento_municipio<-
agrupamento_municipio %>%
  tidyr::pivot_wider(names_from = tipo_deslocamento, values_from = total_internacoes) %>%
  mutate(liquido = ifelse(is.na(entrada),0,entrada)+
           ifelse(is.na(local),0,local)-
           ifelse(is.na(saida),0,saida))

agrupamento_municipio<-
agrupamento_municipio %>%
  mutate(local = ifelse(is.na(local),0,local),
         saida = ifelse(is.na(saida),0,saida),
         entrada = ifelse(is.na(entrada),0,entrada),
         perc_saida = saida/(saida+local)*100,
         perc_entrada = entrada/(entrada+local)*100,
         perc_entrada = ifelse(is.nan(perc_entrada),0,perc_entrada))



municipios_seat<-
municipios_seat %>%
  mutate(code_muni_reduzido = as.character(code_muni),
         code_muni_reduzido = str_sub(code_muni,1,6)) %>%
  inner_join(
    agrupamento_municipio%>%
      rename(code_muni_reduzido = code_muni))


mun_sel_nivel_1A<-
  municipios_seat %>%
  inner_join(
    REGIC_trabalho%>%
      filter(nivel_hierarquia=="1A")%>%
      mutate(code_muni = cod_cidade))

mun_sel_nivel_1B<-
  municipios_seat %>%
  inner_join(
    REGIC_trabalho%>%
      filter(nivel_hierarquia=="1B")%>%
      mutate(code_muni = cod_cidade))


mun_sel_nivel_1C<-
  municipios_seat %>%
  inner_join(
    REGIC_trabalho%>%
      filter(nivel_hierarquia=="1C")%>%
      mutate(code_muni = cod_cidade))


mun_sel_nivel_2A<-
  municipios_seat %>%
  inner_join(
    REGIC_trabalho%>%
      filter(nivel_hierarquia=="2A")%>%
      mutate(code_muni = cod_cidade))

#### funções
busca_municipio_regic<- function(){
  
  municipios<-
  REGIC_trabalho %>%
    inner_join(
      municipios_seat %>%
        mutate(cod_cidade= code_muni)
      ) %>%
    select(name_muni,uf ) %>%
    mutate(name_muni = paste(name_muni, uf, sep = "-")) %>%
    arrange(name_muni)
  
  sort(unique(municipios$name_muni))
}


busca_hierarquia_regic<- function(){
  unique(REGIC_trabalho$nome_nivel_hierarquia_ordenado)
  
}

plot_mapa_entrada_saida <- function (tipo_es, mun_es, somente_dados= FALSE){
  
  muni_sel<-
    municipios_seat %>%
    mutate(name_muni = paste(name_muni,abbrev_state, sep = "-")) %>%
    filter(name_muni %in% mun_es) %>%
    inner_join(
      REGIC_trabalho %>%
        mutate(code_muni = cod_cidade)
    )
  
  
  # muni_sel<-
  #   muni_sel %>%
  #   filter(!(nivel_hierarquia %in% c("1A","1B","1C","2A")))
  
  
  if (tipo_es=="e"){
    texto_legenda <- "% de pacientes internados de outros municípios"
    var_fill<- "perc_entrada"
    
  } else {
    texto_legenda <- "% de pacientes internados em outros municípios"
    var_fill<- "perc_saida"
  }
  
  dados<-
    municipios_seat %>%
    mutate(code_muni = str_sub(as.character(code_muni),1,6)) %>%
    inner_join(
      REGIC_trabalho%>%
        mutate(code_muni = str_sub(as.character(cod_cidade),1,6))
    )
  
  if (somente_dados){
    return(dados)
  }
  
  
  dados %>%
    ggplot()+
    geom_sf(data = estados_mapa, fill=NA, color="#808080")+
    geom_sf(aes( fill= !!sym(var_fill)),pch=21, color="#444444", size=0.8, alpha=0.6)+
    geom_sf(data= mun_sel_nivel_1A, aes( fill= !!sym(var_fill)),pch=21, color="#444444", size=1, alpha=1)+
    geom_sf(data= mun_sel_nivel_1B, aes( fill= !!sym(var_fill)),pch=21, color="#444444", size=1, alpha=1)+
    geom_sf(data= mun_sel_nivel_1C, aes( fill= !!sym(var_fill)),pch=21, color="#444444", size=1, alpha=1)+
    geom_sf(data= mun_sel_nivel_2A, aes( fill= !!sym(var_fill)),pch=21, color="#444444", size=1, alpha=1)+
    geom_sf(data= muni_sel, aes( fill= !!sym(var_fill)),pch=21, color="white", size=1, alpha=1)+
    # geom_text_repel(data = mun_sel_nivel_1A,aes(x=X, y=Y, label= name_muni),fontface = "bold", color="white",size=2.5)+
    # geom_text_repel(data = mun_sel_nivel_1B,aes(x=X, y=Y, label= name_muni),fontface = "bold", color="white",size=2.5)+
    # geom_text_repel(data = mun_sel_nivel_1C,aes(x=X, y=Y, label= name_muni),fontface = "bold", color="white",size=2.5)+
    # geom_text_repel(data = mun_sel_nivel_2A,aes(x=X, y=Y, label= name_muni),fontface = "bold", color="white", force =2,size=2.5)+
    geom_text_repel(data = muni_sel,aes(x=X, y=Y,
                                        label= str_wrap(
                                          str_c(name_muni,
                                                round(!!sym(var_fill),2),
                                                "%",
                                                sep = " "
                                          )
                                          ,20)
    ),fontface = "bold", color="white")+
    scale_fill_continuous_sequential(palette= "Heat 2")+
    scale_color_continuous_sequential(palette= "Heat 2")+
    labs(
      fill= str_wrap(texto_legenda,15) 
    )+
    theme_light() +
    theme(
      panel.background = element_rect(fill = "black"),
      panel.grid = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      strip.background = element_rect(fill = "#505050"),
      strip.text = element_text(color = "white"),
      axis.text = element_blank()
    )+
    facet_wrap(nome_nivel_hierarquia_ordenado~.)
  
  
}

busca_todos_municipios<- function(){
  
  .data<- municipios
  
  .data$munuf<- paste(.data$name_muni, .data$abbrev_state, sep = "-")
  #sort(unique(dataset_analise$munuf))
  sort(.data$munuf)
}

busca_codigo_municipio<- function(nome_uf_mun, seis_digitos = TRUE){
  
  municipios_sel<-
  municipios %>%
    mutate(uf_mun = paste(name_muni, abbrev_state, sep="-")) %>%
    filter(uf_mun %in% nome_uf_mun) %>%
    select(code_muni)
  
  
  if(seis_digitos){
    municipios_sel$code_muni<- substr(municipios_sel$code_muni,1,6)
  }
  
  return(as.character(municipios_sel$code_muni))
  
}


```



Uma análise
=====================================  
### Um storytelling antes dos paineis


```{r}

renderUI({
  
   tags$iframe(src = "https://fernandobarbalho.github.io/siconfi_hospitais/", height="100%", width="100%")
  

})



```




REGIC
=====================================  

Inputs {.sidebar data-width=150} 
-------------------------------------

```{r}
selectInput(inputId = "regic_mun", label= "Selecione um ou mais municipios", choices= busca_municipio_regic(),selected = busca_municipio_regic()[1], multiple = TRUE, selectize = TRUE )

# Create placeholder for the downloadButton
uiOutput("downloadUI_mapa_regic")
# Create the actual downloadButton

output$downloadUI_mapa_regic <- renderUI( {
  downloadButton("download_mapa_regic","Download", style = "width:100%;")
})


output$download_mapa_regic<- downloadHandler(
  filename = function() {
    paste('dados_mapa_regic',  '.csv', sep='')
  },
  content = function(file) {

    dados_mapa_regic <- graph_mapa_regic$data
    write.table(dados_mapa_regic, file, sep = ",",row.names = FALSE,fileEncoding = "UTF-8",dec=".")
  }
)

```


Column
-----------------------------------------------------------------------

### Mapa dinâmico da divisão do REGIC

```{r}

renderPlot({
  
  

  muni_sel<-
  municipios_seat %>%
    mutate(munuf = paste(name_muni,abbrev_state, sep = "-")) %>%
    filter(munuf %in% input$regic_mun) %>%
    inner_join(
      pop_municipios%>%
        mutate(code_muni= as.numeric(id_municipio))
    ) %>%
    inner_join(
      REGIC_trabalho %>%
        mutate(code_muni = cod_cidade)
    )
    
  
  muni_sel<-
    muni_sel %>%
    filter(!(nivel_hierarquia %in% c("1A","1B","1C","2A")))

  
    
  graph_mapa_regic<<-
  municipios_seat %>%
  inner_join(
    REGIC_trabalho %>%
      mutate(code_muni = cod_cidade))%>%
  inner_join(
        pop_municipios %>%
      mutate(code_muni = as.numeric(id_municipio))
  ) %>%
  ggplot()+
  geom_sf(data = estados_mapa, fill=NA, color="#808080")+
  geom_sf(aes( fill= pop_cut),pch=21, color="#444444", size=0.5, alpha=0.5)+
  geom_sf(data= muni_sel, aes( fill= pop_cut),pch=21, color="white", size=2, alpha=1)+
  geom_sf(data= mun_sel_nivel_1A, aes( fill= pop_cut),pch=21, color="#444444", size=2, alpha=1)+
  geom_sf(data= mun_sel_nivel_1B, aes( fill= pop_cut),pch=21, color="#444444", size=2, alpha=1)+
  geom_sf(data= mun_sel_nivel_1C, aes( fill= pop_cut),pch=21, color="#444444", size=2, alpha=1)+
  geom_sf(data= mun_sel_nivel_2A, aes( fill= pop_cut),pch=21, color="#444444", size=2, alpha=1)+
  geom_text_repel(data = mun_sel_nivel_1A,aes(x=X, y=Y, label= name_muni),fontface = "bold", color="white")+
  geom_text_repel(data = mun_sel_nivel_1B,aes(x=X, y=Y, label= name_muni),fontface = "bold", color="white")+
  geom_text_repel(data = mun_sel_nivel_1C,aes(x=X, y=Y, label= name_muni),fontface = "bold", color="white")+
  geom_text_repel(data = mun_sel_nivel_2A,aes(x=X, y=Y, label= name_muni),fontface = "bold", color="white", force =2)+
  geom_text_repel(data = muni_sel,aes(x=X, y=Y, 
                                      label= str_wrap(
                                        str_c(name_muni,
                                              round(populacao/1000,1), 
                                              ifelse(populacao/1000<1000,"mil hab.","milhões hab."),
                                              sep = " "
                                              )
                                        ,20)
                                      ),fontface = "bold", color="white")+
  scale_fill_viridis(discrete = TRUE)+
  labs(
    fill= str_wrap("População (nº de habitantes)",20) 
  )+
  theme_light() +
  theme(
    panel.background = element_rect(fill = "#15202B"),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.background = element_rect(fill = "#505050"),
    strip.text = element_text(color = "white"),
    axis.text = element_blank(),
    legend.key = element_rect(fill = "#15202B")
    
  )+
  facet_wrap(nome_nivel_hierarquia_ordenado~.)
  
  
  graph_mapa_regic
})
```



Fluxo de pacientes - Brasil 
=====================================  

Inputs {.sidebar data-width=150} 
-------------------------------------

```{r}
selectInput(inputId = "regic_mun_io", label= "Selecione um ou mais municipios", choices= busca_municipio_regic(),selected = busca_municipio_regic()[1], multiple = TRUE,selectize = TRUE )

# Create placeholder for the downloadButton
uiOutput("downloadUI_mapa_es_paciente")
# Create the actual downloadButton

output$downloadUI_mapa_es_paciente <- renderUI( {
  downloadButton("download_mapa_es_paciente","Download", style = "width:100%;")
})


output$download_mapa_es_paciente<- downloadHandler(
  filename = function() {
    paste('dados_mapa_es_paciente',  '.csv', sep='')
  },
  content = function(file) {

    dados_mapa_es_paciente <- 
      bind_rows(
        plot_saida_paciente$data,
        plot_entrada_paciente$data
      )
      
    write.table(dados_mapa_es_paciente, file, sep = ",",row.names = FALSE,fileEncoding = "UTF-8",dec=".")
  }
)


```


Column
-----------------------------------------------------------------------


### Saída de pacientes para outros municípios


```{r}
  
renderPlot({
  
  plot_saida_paciente<<-
  plot_mapa_entrada_saida("s",input$regic_mun_io)
  
  plot_saida_paciente
  
})


```


Column
-----------------------------------------------------------------------


### Entrada de pacientes de outros municípios


```{r}
  
renderPlot({
  
  plot_entrada_paciente<<-
  plot_mapa_entrada_saida("e",input$regic_mun_io)
  
  plot_entrada_paciente
})

```


Fluxos por REGIC
=====================================  

Inputs {.sidebar data-width=150} 
-------------------------------------

```{r}
selectInput(inputId = "regic_hierarquia_s", label= "Selecione uma ou mais hierariquias pra saída", choices= busca_hierarquia_regic(),selected = "Centro Local", multiple = TRUE, selectize = TRUE )


selectInput(inputId = "regic_hierarquia_e", label= "Selecione uma ou mais hierariquias pra saída", choices= busca_hierarquia_regic(),selected = busca_hierarquia_regic(), multiple = TRUE, selectize = TRUE )

checkboxInput(inputId = "histograma",label = "Exibe histograma", value = TRUE)

# Create placeholder for the downloadButton
uiOutput("downloadUI_aluvial")
# Create the actual downloadButton

output$downloadUI_aluvial <- renderUI( {
  downloadButton("download_aluvial","Download", style = "width:100%;")
})


output$download_aluvial<- downloadHandler(
  filename = function() {
    paste('dados_aluvial',  '.csv', sep='')
  },
  content = function(file) {

    dados_aluvial <- dado_grafico_aluvial

    write.table(dados_aluvial, file, sep = ",",row.names = FALSE,fileEncoding = "UTF-8",dec=".")
  }
)


```


Column
-----------------------------------------------------------------------


### Fluxos por nível hierárquico de REGIC


```{r}
render_parcats({

hierarquia_saida<- input$regic_hierarquia_s
hierarquia_entrada <- input$regic_hierarquia_e
    
#hierarquia_saida<- "Centro Local"
#hierarquia_entrada <- busca_hierarquia_regic()


ordem_y<- 
dataset_analise %>%
  filter(deslocamento==1,
         nome_nivel_hierarquia.x == hierarquia_saida,
         !(is.na(nome_nivel_hierarquia.y))) %>%
  group_by(nome_nivel_hierarquia.y) %>%
  summarise(
    quantidade = n()
  )  %>%
  ungroup() %>%
   inner_join(
     de_para_hierarquia %>%
       rename(nome_nivel_hierarquia.y=nome_nivel_hierarquia,
              entrada_abreviado = nome_abreviado)) %>%
  arrange(quantidade) %>%
  mutate(entrada = entrada_abreviado)



 aluvial<-
     dataset_analise %>%
  filter(deslocamento==1,
         nome_nivel_hierarquia.x %in% hierarquia_saida,
         nome_nivel_hierarquia.y %in% hierarquia_entrada,
         !(is.na(nome_nivel_hierarquia.y))) %>%
  mutate(saída = nome_nivel_hierarquia.x,
         entrada =nome_nivel_hierarquia.y ) %>%
  select(saída, entrada) 
 

 aluvial<- 
   aluvial %>%
   inner_join(
     de_para_hierarquia %>%
       rename(saída=nome_nivel_hierarquia,
              saida_abreviado = nome_abreviado)) %>%
   inner_join(
     de_para_hierarquia %>%
       rename(entrada=nome_nivel_hierarquia,
              entrada_abreviado = nome_abreviado)) %>%
   select(saida_abreviado, entrada_abreviado ) %>%
   rename(saída= saida_abreviado,
          entrada = entrada_abreviado)
 
 aluvial$entrada <- factor(aluvial$entrada, levels = unique(ordem_y$entrada[order(ordem_y$quantidade)])) 

 dado_grafico_aluvial<<- aluvial

 p<-
  alluvial_wide( data = aluvial, 
                max_variables = 2, 
                fill_by = 'first_variable') 


parcats::parcats(p, 
                 data_input = aluvial,
                 marginal_histograms = input$histograma,
                 labelfont = list(size = 15, color = "black"), 
                 sortpaths= "backwards")
  
  

  
})

```

Fluxo por cidade
=====================================  

Inputs {.sidebar data-width=150} 
-------------------------------------

```{r}
selectInput(inputId = "regic_mun_desloc", label= "Selecione um municipio", choices= busca_todos_municipios(),selected = "Recife-PE", multiple = FALSE, selectize = TRUE )

sliderInput(inputId= "num_destaque", label = "Número de cidades em destaques", min=1, max = 5, value=1 )

# Create placeholder for the downloadButton
uiOutput("downloadUI_mapa_s_cidade")
# Create the actual downloadButton

output$downloadUI_mapa_s_cidade <- renderUI( {
  downloadButton("download_mapa_s_cidade","Saída", style = "width:100%;")
})


output$download_mapa_s_cidade<- downloadHandler(
  filename = function() {
    paste('dados_mapa_s_cidade',  '.csv', sep='')
  },
  content = function(file) {

    dados_mapa_s_cidade <- 
      bind_rows(
        g1_saida$data,
        g2_saida$data
      )
      
    write.table(dados_mapa_s_cidade, file, sep = ",",row.names = FALSE,fileEncoding = "UTF-8",dec=".")
  }
)


# Create placeholder for the downloadButton
uiOutput("downloadUI_mapa_e_cidade")
# Create the actual downloadButton

output$downloadUI_mapa_e_cidade <- renderUI( {
  downloadButton("download_mapa_e_cidade","Entrada", style = "width:100%;")
})


output$download_mapa_e_cidade<- downloadHandler(
  filename = function() {
    paste('dados_mapa_e_cidade',  '.csv', sep='')
  },
  content = function(file) {

    dados_mapa_e_cidade <- 
      bind_rows(
        g1_entrada$data,
        g2_entrada$data
      )
      
    write.table(dados_mapa_e_cidade, file, sep = ",",row.names = FALSE,fileEncoding = "UTF-8",dec=".")
  }
)


```


Column {.tabset}
-----------------------------------------------------------------------


### Saída


```{r}
renderPlot({
  
  codigo_muni<-
    busca_codigo_municipio(input$regic_mun_desloc)
  
  
  print(codigo_muni)


  
  muni_sel<- 
    dataset_analise %>%
    filter(deslocamento ==1,
           munic_res ==	codigo_muni) %>%
    group_by(munic_res,nome_nivel_hierarquia_ordenado.x, uf.x) %>%
    summarise(quantidade = n()) %>%
    rename(code_muni= munic_res,
           hierarquia = nome_nivel_hierarquia_ordenado.x,
           uf = uf.x) %>%
    mutate(tipo_deslocamento  = "origem",
           distancia = 0) %>%
    bind_rows(
      dataset_analise %>%
        filter(deslocamento ==1,
               munic_res==	codigo_muni) %>%
        group_by(codufmun,nome_nivel_hierarquia_ordenado.y, uf.y) %>%
        summarise(
          quantidade = n(),
          distancia =min(distancia)
        ) %>%
        ungroup() %>%
        rename(code_muni= codufmun,
               hierarquia = nome_nivel_hierarquia_ordenado.y,
               uf=uf.y)%>%
        mutate(tipo_deslocamento  = "destino")
    ) %>%
    ungroup() 
  
  
  
  
  muni_sel_posicao<-
    dataset_analise %>%
    filter(deslocamento ==1,
           munic_res==	codigo_muni) %>%
    distinct(munic_res, mun_res_lat.x, mun_res_lat.y, mun_res_lon.x, mun_res_lon.y,distancia)
  
  muni_sel_posicao<-
    municipios_seat %>%
    mutate(code_muni = str_sub(as.character(code_muni),1,6)) %>%
    inner_join(
      muni_sel_posicao %>%
        rename(code_muni= munic_res)
    ) 
  

  xmin<- min(min(muni_sel_posicao$mun_res_lon.x), min(muni_sel_posicao$mun_res_lon.y)) -1
  xmax <- max(max(muni_sel_posicao$mun_res_lon.x), max(muni_sel_posicao$mun_res_lon.y)) +1
  
  
  ymin<- min(min(muni_sel_posicao$mun_res_lat.x), min(muni_sel_posicao$mun_res_lat.y)) -1
  ymax <- max(max(muni_sel_posicao$mun_res_lat.x), max(muni_sel_posicao$mun_res_lat.y)) +1
  
  g1_saida<<-
    municipios_seat %>%
    mutate(code_muni = str_sub(as.character(code_muni),1,6)) %>%
    inner_join(
      muni_sel
    ) %>%
    ggplot()+
    geom_sf(data = estados_mapa, fill=NA, color= "lightgreen")+
    geom_curve(data=muni_sel_posicao, aes(x=mun_res_lon.x,y=mun_res_lat.x,xend=mun_res_lon.y,yend=mun_res_lat.y, colour= distancia),
               curvature = -.25, ncp = 800,size = 1)+
    geom_sf(fill="white",size=2,pch=21, color="#444444")+
    scale_fill_discrete_qualitative(palette="dark2")+
    scale_color_continuous_sequential(palette= "Heat 2")+
    coord_sf(xlim = c(xmin,xmax), ylim=c(ymin,ymax))+
    labs(
      
      color = str_wrap("distância em Km",10)
    )+
    theme_light() +
    theme(
      panel.background = element_rect(fill = "black"),
      panel.grid = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      strip.background = element_rect(fill = "#505050"),
      strip.text = element_text(color = "white"),
      axis.text = element_blank(),
      
    ) 
  
  muni_sel_foco<-
    municipios_seat %>%
    mutate(code_muni = str_sub(as.character(code_muni),1,6)) %>%
    inner_join(
      muni_sel%>%
        filter(code_muni==codigo_muni)
    )

  muni_sel_repel<-
    municipios_seat %>%
    mutate(code_muni = str_sub(as.character(code_muni),1,6)) %>%
    inner_join(muni_sel) %>%
    slice_max(order_by = quantidade, n=input$num_destaque)
  

  muni_sel<-
    muni_sel%>%
    filter(code_muni!=codigo_muni)
  
  


  
  g2_saida<<-
    municipios_seat %>%
    mutate(code_muni = str_sub(as.character(code_muni),1,6)) %>%
    inner_join(
      muni_sel
    ) %>%
    ggplot()+
    geom_sf(data = estados_mapa, fill=NA, color="#505050")+
    geom_sf( aes(fill=quantidade),pch=21, color="#444444", size=2)+
    geom_sf( data= muni_sel_foco, aes(size=quantidade),pch=21, color="#444444", fill="white")+
    geom_sf(data= regioes_saude, fill= NA, color = "#505050"  )+
    geom_sf(data = estados_mapa, fill=NA, color= "lightgreen")+#505050

    geom_text_repel(data = muni_sel_repel,
                    aes(x=X, 
                        y=Y, 
                        label= str_wrap(paste(name_muni,":",quantidade),10)),
                    fontface = "bold", 
                    color="white",
                    force_pull = 0,
                    nudge_x = 3,
                    )+
    scale_fill_continuous_sequential(palette= "Heat 2" )+
    coord_sf(xlim = c(xmin,xmax), ylim=c(ymin,ymax))+
    labs(
      fill= str_wrap("Quantidade de entradas",15),
      size= str_wrap("Quantidade de saídas",15)
    )+
    theme_light() +
    theme(
      panel.background = element_rect(fill = "black"),
      panel.grid = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      strip.background = element_rect(fill = "#505050"),
      strip.text = element_text(color = "white"),
      axis.text = element_blank(),
      legend.key = element_rect(fill = "black")
      
    )
  
  
  g1_saida|g2_saida
  
  
})


```


### Entrada


```{r}
renderPlot({
  
  # codigo_muni<-
  #   unique(dataset_analise$codufmun[dataset_analise$mun_res_nome.y==input$regic_mun_desloc])
  
  # codigo_muni<-
  #   unique(dataset_analise$munic_res[dataset_analise$munuf %in% input$regic_mun_desloc])
  
  
  codigo_muni<-
    busca_codigo_municipio(input$regic_mun_desloc)


    
  
  print(codigo_muni)
  
  municipio_selecionado<-codigo_muni
  
  muni_sel<- 
    dataset_analise %>%
    filter(deslocamento ==1,
           codufmun==	municipio_selecionado) %>%
    group_by(codufmun,nome_nivel_hierarquia_ordenado.y, uf.y) %>%
    summarise(quantidade = n()) %>%
    rename(code_muni= codufmun,
           hierarquia = nome_nivel_hierarquia_ordenado.y,
           uf = uf.y) %>%
    mutate(tipo_deslocamento  = "destino",
           distancia = 0) %>%
    bind_rows(
      dataset_analise %>%
        filter(deslocamento ==1,
               codufmun==	municipio_selecionado) %>%
        group_by(munic_res,nome_nivel_hierarquia_ordenado.x, uf.x) %>%
        summarise(
          quantidade = n(),
          distancia =min(distancia)
        ) %>%
        ungroup() %>%
        rename(code_muni= munic_res,
               hierarquia = nome_nivel_hierarquia_ordenado.x,
               uf=uf.x)%>%
        mutate(tipo_deslocamento  = "origem")
    )
  
  
  
  muni_sel_posicao<-
    dataset_analise %>%
    dplyr::filter(deslocamento ==1,
                  codufmun==	municipio_selecionado)%>%
    distinct(codufmun, mun_res_lat.x, mun_res_lat.y, mun_res_lon.x, mun_res_lon.y,distancia)
  
  
  muni_sel_posicao<-
    municipios_seat %>%
    mutate(code_muni = str_sub(as.character(code_muni),1,6)) %>%
    inner_join(
      muni_sel_posicao %>%
        rename(code_muni= codufmun)
    )
  
  

  xmin<- min(min(muni_sel_posicao$mun_res_lon.x), min(muni_sel_posicao$mun_res_lon.y)) -1
  xmax <- max(max(muni_sel_posicao$mun_res_lon.x), max(muni_sel_posicao$mun_res_lon.y)) +1
  
  
  ymin<- min(min(muni_sel_posicao$mun_res_lat.x), min(muni_sel_posicao$mun_res_lat.y)) -1
  ymax <- max(max(muni_sel_posicao$mun_res_lat.x), max(muni_sel_posicao$mun_res_lat.y)) +1
  
  g1_entrada<<-
    municipios_seat %>%
    mutate(code_muni = str_sub(as.character(code_muni),1,6)) %>%
    inner_join(
      muni_sel
    ) %>%
    ggplot()+
    geom_sf(data = estados_mapa, fill=NA, color="lightgreen")+
    geom_curve(data=muni_sel_posicao, aes(x=mun_res_lon.x,y=mun_res_lat.x,xend=mun_res_lon.y,yend=mun_res_lat.y, colour= distancia),
               curvature = -.25, ncp = 800,size = 1)+
    geom_sf(fill="white",size=1.9,pch=21, color="#444444")+
    scale_fill_discrete_qualitative(palette="dark2")+
    scale_color_continuous_sequential(palette= "Heat 2")+
    coord_sf(xlim = c(xmin,xmax), ylim=c(ymin,ymax))+
    labs(
      fill= "",
      color = str_wrap("distância em Km",10)
    )+
    theme_light() +
    theme(
      panel.background = element_rect(fill = "black"),
      panel.grid = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      strip.background = element_rect(fill = "#505050"),
      strip.text = element_text(color = "white"),
      axis.text = element_blank(),
      
    ) 
  
  muni_sel_foco<-
    municipios_seat %>%
    mutate(code_muni = str_sub(as.character(code_muni),1,6)) %>%
    inner_join(
      muni_sel%>%
        filter(code_muni==municipio_selecionado)
    )
  
  muni_sel_repel<-
    municipios_seat %>%
    mutate(code_muni = str_sub(as.character(code_muni),1,6)) %>%
    inner_join(muni_sel) %>%
    slice_max(order_by = quantidade, n=input$num_destaque)
  

  
  
  muni_sel<-
    muni_sel%>%
    filter(code_muni!=municipio_selecionado)
  
  
  set.seed(1972)
  
  g2_entrada<<-
    municipios_seat %>%
    mutate(code_muni = str_sub(as.character(code_muni),1,6)) %>%
    inner_join(
      muni_sel
    ) %>%
    ggplot()+
    geom_sf( aes(fill=quantidade),pch=21, color="#444444", size=2, show.legend = TRUE)+
    geom_sf( data= muni_sel_foco, aes(size=quantidade),pch=21, color="#444444", fill="white")+
    geom_sf(data= regioes_saude, fill= NA, color = "#505050")+
    geom_sf(data = estados_mapa, fill=NA, color="lightgreen")+#505050
    geom_text_repel(data = muni_sel_repel,
                    aes(x=X, y=Y, label= str_wrap(paste(name_muni,":",quantidade),10)), 
                    color = "white", 
                    fontface = "bold",
                    show.legend = TRUE,
                    force_pull = 0,
                    nudge_x = 3)+
    scale_fill_continuous_sequential(palette= "Heat", trans= "log2" )+
    coord_sf(xlim = c(xmin,xmax), ylim=c(ymin,ymax))+
    labs(
      
      fill = str_wrap("Quantidade de saídas",15),
      size= str_wrap("Quantidade de entradas",15)
    )+
    theme_light() +
    theme(
      panel.background = element_rect(fill = "black"),
      panel.grid = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      strip.background = element_rect(fill = "#505050"),
      strip.text = element_text(color = "white"),
      axis.text = element_blank(),
      legend.key = element_rect(fill = "#15202B")
      
    )
  
  
  
  
  
  
  library(patchwork)
  
  g1_entrada|g2_entrada
  
  
})


```

Gastos hospitalares (sem REGIC)
=====================================  

Inputs {.sidebar data-width=150} 
-------------------------------------

```{r}


selectInput(inputId = "mun_gasto", label= "Selecione um ou mais municipios", choices= busca_todos_municipios(),selected = "Recife-PE", multiple = TRUE, selectize = TRUE )


```


Column
-----------------------------------------------------------------------


### Gastos sem análise REGIC



```{r}

renderPlot({
  

# codigo_muni<-
#     unique(dataset_analise$munic_res[str_to_lower(dataset_analise$mun_res_nome.x) %in% str_to_lower(input$mun_gasto)])
# 
# codigo_muni<-
#   unique(dataset_analise$munic_res[dataset_analise$munuf %in% input$mun_gasto])

  codigo_muni<-
    busca_codigo_municipio(input$mun_gasto)



print(input$mun_gasto)
print(codigo_muni)

muni_sel_saida<-
dataset_analise %>%
  filter(deslocamento == 1,
         perc.x>=0,
         perc.x<=50) %>% 
  distinct(nome_nivel_hierarquia.x,munic_res, perc.x, mun_res_nome.x) %>%
  inner_join(
    agrupamento_municipio_cluster %>%
      filter(code_muni %in% codigo_muni) %>%
      rename(munic_res=code_muni)
  )  

g1<-
dataset_analise %>%
  filter(deslocamento == 1,
         perc.x>0,
         perc.x<=50) %>% 
  distinct(nome_nivel_hierarquia.x,munic_res, perc.x) %>%
  inner_join(
    agrupamento_municipio_cluster %>%
      rename(munic_res=code_muni)
  ) %>%
  ggplot() +
  geom_jitter(aes(x=cluster_4_k, y=perc.x, fill=perc_saida), pch=21, color="#444444",size=2)+
  geom_boxplot(aes(x=cluster_4_k, y=perc.x),fill=NA, color= "white", outlier.shape = NA)+
  geom_point(data= muni_sel_saida, aes(x=cluster_4_k, y=perc.x, fill=perc_saida), pch=21, color="white",size=4)+
  geom_label_repel(data= muni_sel_saida, aes(x=cluster_4_k, y=perc.x,label= mun_res_nome.x),color="black", force_pull = 0)+
  scale_fill_continuous_sequential(palette= "Red-Yellow")+
  theme_light() +
  theme(
    text = element_text(size=18),
    panel.background = element_rect(fill = "black"),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    strip.background = element_rect(fill = "#505050"),
    strip.text = element_text(color = "white"),
    #axis.text = element_blank(),
    axis.text.x = element_text(angle = 45, vjust = 0.5),
    legend.key = element_rect(fill = "#15202B")

  )+
  labs(
    fill= "(%) saída",
    y = "Gastos Hospitalares e ambulatoriais - (%) do total"
  )


muni_sel_entrada<-
dataset_analise %>%
  filter(deslocamento == 1,
         perc.y>=0,
         perc.y<=50) %>% 
  distinct(nome_nivel_hierarquia.y,codufmun, perc.y, mun_res_nome.y) %>%
  inner_join(
    agrupamento_municipio_cluster %>%
      filter(code_muni %in% codigo_muni) %>%
      rename(codufmun=code_muni)
  )  



g2<-
dataset_analise %>%
  filter(deslocamento == 1,
         perc.y>0,
         perc.y<=50) %>%
  distinct(nome_nivel_hierarquia.y,codufmun, perc.y) %>%
  inner_join(
    agrupamento_municipio_cluster %>%
      rename(codufmun=code_muni)
  ) %>%
  ggplot() +
  geom_jitter(aes(x=cluster_4_k, y=perc.y, fill=perc_entrada), pch=21, color="#444444",size=2)+
  geom_boxplot(aes(x=cluster_4_k, y=perc.y),fill=NA, color= "white", outlier.shape = NA)+
  geom_point(data= muni_sel_entrada, aes(x=cluster_4_k, y=perc.y, fill=perc_entrada), pch=21, color="white",size=4, )+
  geom_label_repel(data= muni_sel_entrada, aes(x=cluster_4_k, y=perc.y,label= mun_res_nome.y), color="black", fontface = "bold", force_pull = 0)+
  scale_fill_continuous_sequential(palette= "Red-Yellow")+
  theme_light() +
  theme(
    text = element_text(size=18),
    panel.background = element_rect(fill = "black"),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    strip.background = element_rect(fill = "#505050"),
    strip.text = element_text(color = "white"),
    axis.text.x = element_text(angle = 45, vjust = 0.5),
    legend.key = element_rect(fill = "#15202B")

  )+
  labs(
    fill= "(%) entrada",
    y = "Gastos Hospitalares e ambulatoriais - (%) do total"
  )

g1|g2

})

```


Gastos hospitalares (REGIC)
=====================================  

Inputs {.sidebar data-width=150} 
-------------------------------------

```{r}
selectInput(inputId = "regic_mun_gasto", label= "Selecione um ou mais municipios", choices= busca_municipio_regic(),selected = "Recife-PE", multiple = TRUE, selectize = TRUE )


```


Column
-----------------------------------------------------------------------


### Gastos com análise REGIC




```{r}

renderPlot({
  
  

# codigo_muni<-
#   unique(dataset_analise$munic_res[str_to_lower(dataset_analise$mun_res_nome.x) %in%
#                                      str_to_lower(input$regic_mun_gasto)])

  
  codigo_muni<-
    busca_codigo_municipio(input$regic_mun_gasto)


  muni_sel_saida<-
  dataset_analise %>%
  filter(deslocamento == 1,
         perc.x>=0,
         perc.x<=50,
         !is.na(nome_nivel_hierarquia.x)) %>% #filtro para tirar os outliers
  distinct(nome_nivel_hierarquia_ordenado.x,munic_res, perc.x, mun_res_nome.x) %>%
  inner_join(
    agrupamento_municipio_cluster %>%
        filter(code_muni %in% codigo_muni) %>%
      rename(munic_res=code_muni) 
  ) %>%
  mutate(tipo_analise = "Saída",
         hierarquia=nome_nivel_hierarquia_ordenado.x,
         percentual = perc.x)
  
  muni_sel_entrada<-
    dataset_analise %>%
      filter(deslocamento == 1,
             perc.y>=0,
             perc.y<=50,
             !is.na(nome_nivel_hierarquia.y)) %>% #filtro para tirar os outliers
      distinct(nome_nivel_hierarquia_ordenado.y,codufmun, perc.y,mun_res_nome.y) %>%
      inner_join(
        agrupamento_municipio_cluster %>%
        filter(code_muni %in% codigo_muni) %>%
          rename(codufmun=code_muni) 
      ) %>%
      mutate(tipo_analise = "Entrada",
             hierarquia=nome_nivel_hierarquia_ordenado.y,
             percentual = perc.y)
  

  dataset_analise %>%
  filter(deslocamento == 1,
         perc.x>0,
         perc.x<=50,
         !is.na(nome_nivel_hierarquia.x)) %>% #filtro para tirar os outliers
  distinct(nome_nivel_hierarquia_ordenado.x,munic_res, perc.x) %>%
  inner_join(
    agrupamento_municipio_cluster %>%
      rename(munic_res=code_muni) 
  ) %>%
  mutate(tipo_analise = "Saída",
         hierarquia=nome_nivel_hierarquia_ordenado.x,
         percentual = perc.x) %>%
  bind_rows(
    dataset_analise %>%
      filter(deslocamento == 1,
             perc.y>0,
             perc.y<=50,
             !is.na(nome_nivel_hierarquia.y)) %>% #filtro para tirar os outliers
      distinct(nome_nivel_hierarquia_ordenado.y,codufmun, perc.y) %>%
      inner_join(
        agrupamento_municipio_cluster %>%
          rename(codufmun=code_muni) 
      ) %>%
      mutate(tipo_analise = "Entrada",
             hierarquia=nome_nivel_hierarquia_ordenado.y,
             percentual = perc.y)
  )%>%
  ggplot() +
  geom_jitter(aes(x=hierarquia, y=percentual, fill=cluster_4_k), pch=21, color="#444444",size=2)+
  geom_boxplot(aes(x=hierarquia, y=percentual),fill=NA, color= "white", outlier.shape = NA)+
  geom_point(data= muni_sel_entrada, aes(x=hierarquia, y=percentual, fill=cluster_4_k), pch=21, color="white",size=4, )+
  geom_point(data= muni_sel_saida, aes(x=hierarquia, y=percentual, fill=cluster_4_k), pch=21, color="white",size=4, )+
  geom_label_repel(data= muni_sel_entrada, aes(x=hierarquia, y=percentual,label= mun_res_nome.y), color="black", fontface = "bold", force_pull = 0)+
  geom_label_repel(data= muni_sel_saida, aes(x=hierarquia, y=percentual,label= mun_res_nome.x), color="black", fontface = "bold", force_pull = 0)+
  scale_fill_discrete_divergingx(palette= "Zissou 1")+
  theme_light() +
  theme(
    text = element_text(size=18),
    panel.background = element_rect(fill = "black"),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    strip.background = element_rect(fill = "#505050"),
    strip.text = element_text(color = "white"),
    axis.text.x = element_text(angle = 45, vjust = 0.5),

  )+
  labs(
    fill= str_wrap("Tipo agrupamento",15),
    y = "Gastos Hospitalares e ambulatoriais - (%) do total"
  )+
  facet_grid(tipo_analise~.)

  
})
```


Raio-X dos municípios
=====================================  



Column
-----------------------------------------------------------------------


### Tabela de municípios

```{r}
DT::renderDataTable(server = FALSE, {
  
  selecao<-
dataset_analise %>%
  filter(deslocamento == 1) %>% # antes havia esse filtro complementar: ,perc.x>=0,perc.x<=50
  distinct(nome_nivel_hierarquia.x,munic_res,uf.x, perc.x, mun_res_nome.x) %>%
  inner_join(
    agrupamento_municipio_cluster %>%
      rename(munic_res=code_muni)
  ) %>%
  rename(codigo_muni=munic_res) %>% 
  inner_join(
    pop_municipios %>%
      select(id_municipio,
             sigla_uf) %>%
      mutate(codigo_muni=  str_sub(id_municipio,1,6))
  ) %>%
  mutate(uf.x = sigla_uf)  

    

  selecao %>%
    select(-c(liquido,id_agrupamento)) %>%
    select(codigo_muni,
           mun_res_nome.x,
           uf.x,
           perc.x,
           nome_nivel_hierarquia.x,
           entrada,
           local,
           saida,
           perc_saida,
           perc_entrada,
           cluster_4_k) %>%
    arrange(mun_res_nome.x) %>%
  datatable(
            colnames = c("Código Município",
                         "Município",
                         "UF",
                         "% gasto",
                         "REGIC",
                         "Entrada de paciente",
                         "Atendimento local",
                         "Saída de paciente",
                         "% atendimentos em outra cidade",
                         "% atendimentos de outra cidade",
                         "Agrupamento"
                         ), 
            fillContainer = TRUE,
            extensions = "Buttons", 
            rownames = FALSE,
            filter = 'top',
            selection= "none",
            options = list(pageLength = 50 , 
                           dom = 'Bfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
                      ) 
            )%>%
    formatRound(c(4,9,10),digits = 2, mark=".", dec.mark= ",")%>%
    formatRound(c(6:8),digits = 0, mark=".", dec.mark= ",")
  
})

```


Síntese
=====================================  


Inputs {.sidebar}
-------------------------------------

```{r}
# shiny inputs defined here
selectInput(inputId = "regic_mun_vis", label= "Selecione um municipio", choices= busca_todos_municipios(),selected = "Recife", multiple = FALSE, selectize = TRUE )



# Create placeholder for the downloadButton
```



Column
-----------------------------------------------------------------------


### Diagnóstico de oferta e demanda de atendimento para o município   


```{r}

renderDT({
  
  codigo_muni<-
    busca_codigo_municipio(input$regic_mun_vis)



  
  selecao<-
    dataset_analise %>%
    filter(deslocamento == 1,
           munic_res == codigo_muni) %>% # antes havia esse filtro complementar: ,perc.x>=0,perc.x<=50
    distinct(nome_nivel_hierarquia.x,munic_res, uf.x,perc.x, mun_res_nome.x) %>%
    inner_join(
      agrupamento_municipio_cluster %>%
        rename(munic_res=code_muni)
    ) %>%
    rename(codigo_muni=munic_res)%>% 
    inner_join(
      pop_municipios %>%
        select(id_municipio,
               sigla_uf) %>%
        mutate(codigo_muni=  str_sub(id_municipio,1,6))
    ) %>%
    mutate(uf.x = sigla_uf)  
  
  selecao<-
    selecao %>%
    select(-c(liquido,id_agrupamento)) %>%
    select(codigo_muni,
           mun_res_nome.x,
           uf.x,
           perc.x,
           nome_nivel_hierarquia.x,
           entrada,
           local,
           saida,
           perc_saida,
           perc_entrada,
           cluster_4_k)
  
  num_paciente_entrada<<- selecao$entrada[1]
  num_paciente_saida<<- selecao$saida[1]
  
  sel_graf<-
    selecao
  
  
  sel_graf %>%
    datatable(
      colnames = c("Código Município",
                   "Município",
                   "UF",
                   "% gasto",
                   "REGIC",
                   "Entrada de paciente",
                   "Atendimento local",
                   "Saída de paciente",
                   "% atendimentos em outra cidade",
                   "% atendimentos de outra cidade",
                   "Agrupamento"
      ),
      options = list(dom = 't'),
      #fillContainer = TRUE,
      rownames = FALSE,
      #filter = 'top' 
    )%>%
    formatRound(c(4,9,10),digits = 2, mark=".", dec.mark= ",")%>%
    formatRound(c(6:8),digits = 0, mark=".", dec.mark= ",")
  
  
})


```

### Cinco destinos mais frequentes dos pacientes do municípios


```{r}

#Para onde vão 80% dos pacientes que são atendidos fora do município
renderDT({
  
  codigo_muni<-
    busca_codigo_municipio(input$regic_mun_vis)
  
  print(codigo_muni)


  
  muni_sel<- 
    dataset_analise %>%
    filter(deslocamento ==1,
           munic_res ==	codigo_muni) %>%
    group_by(munic_res,mun_res_nome.x,nome_nivel_hierarquia_ordenado.x, uf.x) %>%
    summarise(quantidade = n()) %>%
    rename(code_muni= munic_res,
           hierarquia = nome_nivel_hierarquia_ordenado.x,
           uf = uf.x) %>%
    mutate(tipo_deslocamento  = "origem",
           distancia = 0) %>%
    bind_rows(
      dataset_analise %>%
        filter(deslocamento ==1,
               munic_res==	codigo_muni) %>%
        group_by(codufmun,mun_res_nome.y, nome_nivel_hierarquia_ordenado.y, uf.y) %>%
        summarise(
          quantidade = n(),
          distancia =min(distancia)
        ) %>%
        ungroup() %>%
        rename(code_muni= codufmun,
               hierarquia = nome_nivel_hierarquia_ordenado.y,
               uf=uf.y)%>%
        mutate(tipo_deslocamento  = "destino")
    ) %>%
    filter(distancia != 0) %>%
    ungroup()%>% 
    inner_join(
      pop_municipios %>%
        select(id_municipio,
               sigla_uf) %>%
        mutate(code_muni=  str_sub(id_municipio,1,6))
    ) %>%
    #arrange(desc(quantidade)) %>%
    mutate(uf = sigla_uf,
           perc_paciente_saida = round(quantidade/num_paciente_saida,2)*100) %>%  
    slice_max(quantidade, n= 5) %>%
    select(
      code_muni,
      mun_res_nome.y,
      uf,
      hierarquia, 
      perc_paciente_saida,
      distancia
    )
  
  
  muni_sel %>%
    datatable(
      colnames = c("Código Município",
                   "Município",
                   "UF",
                   "REGIC",
                   "% de pacientes que saem",
                   "Distância em km"
      ),
      options = list(dom = 't'),
      #fillContainer = TRUE,
      rownames = FALSE,
      #filter = 'top'
    )%>%
    formatRound(6,digits = 2, mark=".", dec.mark= ",")
  
  
})


```



### Cinco origens mais frequentes dos pacientes atendidos no município


```{r}

renderDT({
  
  
  codigo_muni<-
    busca_codigo_municipio(input$regic_mun_vis)

  
  if (NROW(unique(dataset_analise$codufmun[dataset_analise$codufmun==codigo_muni])) == 0){
    return()
  }
  
  # codigo_muni<-
  #   unique(dataset_analise$codufmun[dataset_analise$mun_res_nome.y==input$regic_mun_vis])
  
  print("codigo_muni")
  print(codigo_muni)
  

  municipio_selecionado<-codigo_muni
  
  muni_sel<- 
    dataset_analise %>%
    filter(deslocamento ==1,
           codufmun==	municipio_selecionado) %>%
    group_by(codufmun,mun_res_nome.y,nome_nivel_hierarquia_ordenado.y, uf.y) %>%
    summarise(quantidade = n()) %>%
    rename(code_muni= codufmun,
           hierarquia = nome_nivel_hierarquia_ordenado.y,
           uf = uf.y) %>%
    mutate(tipo_deslocamento  = "destino",
           distancia = 0) %>%
    bind_rows(
      dataset_analise %>%
        filter(deslocamento ==1,
               codufmun==	municipio_selecionado) %>%
        group_by(munic_res,mun_res_nome.x, nome_nivel_hierarquia_ordenado.x, uf.x) %>%
        summarise(
          quantidade = n(),
          distancia =min(distancia)
        ) %>%
        ungroup() %>%
        rename(code_muni= munic_res,
               hierarquia = nome_nivel_hierarquia_ordenado.x,
               uf=uf.x)%>%
        mutate(tipo_deslocamento  = "origem")
    )%>%
    filter(distancia != 0) %>%
    ungroup()%>% 
    inner_join(
      pop_municipios %>%
        select(id_municipio,
               sigla_uf) %>%
        mutate(code_muni=  str_sub(id_municipio,1,6))
    ) %>%
    mutate(uf = sigla_uf,
           perc_paciente_entrada = round(quantidade/num_paciente_entrada,2)*100) %>%
    slice_max(quantidade, n= 5) %>%
    select(
      code_muni,
      mun_res_nome.x,
      uf,
      hierarquia, 
      perc_paciente_entrada,
      distancia
    )
  
  

  
  muni_sel %>%
    datatable(
      colnames = c("Código Município",
                   "Município",
                   "UF",
                   "REGIC",
                   "% de pacientes de outros municípios",
                   "Distância em km"
      ),
      options = list(dom = 't'),
      #fillContainer = TRUE,
      rownames = FALSE,
      #filter = 'top'
    )%>%
    formatRound(6,digits = 2, mark=".", dec.mark= ",")
  
  
})


```

### Copie o texto abaixo e cole na sua interface de IA (ex: chatGPT, Bard). Se usar essa funcionalidade confira o texto gerado pela IA comparando com os dados e conceitos do estudo.


```{r}

renderDataTable({
  
  str_info_metodologia<- tibble(texto=character(12))
  
  str_info_metodologia$texto[1]<- "O portal deslocamentos e gastos hospitalares dos municípios traz um estudo e paineis que buscam identificar a associação entre gastos municipais com atendimentos hospitalares e deslocamento de pacientes para outros municípios."
  
  str_info_metodologia$texto[2]<- "Metadados:"
  
  str_info_metodologia$texto[3]<- "1- Fonte: Datasus (SIH e CNES), IBGE e STN."
  
  str_info_metodologia$texto[4] <- "2- Os dados são todos de 2021"
  
  str_info_metodologia$texto[5]<- "3- O estudo foi produzido pela Secretaria do Tesouro Nacional (STN) e está disponível a partir do endereço  https://siconfi-atendimento-hospitalar.tesouro.gov.br/"
  
  str_info_metodologia$texto[6]<- "Metodologia:"
  
  str_info_metodologia$texto[7]<- "Os muncípios foram analisados tendo como referência o modelo REGIC de hierarquia das cidades do Brasil a partir da influência e capacidade de gestão das cidades. O modelo REGIC foi produzido pelo IBGE."
  
  
  str_info_metodologia$texto[8]<- "Para cada município foi identificado o percentual de pacientes da cidade que é atendido em outras cidades e também o percentual de atendimentos feitos na cidade que corresponde a pacientes vindos de outras cidades"
  
  
  str_info_metodologia$texto[9]<- "O estudo apresenta agrupamentos de cidades a partir da combinação do percentual de entrada de pacientes vindos de outros municípios com o percentual de pacientes da cidade que são atendidos em outras localidades. Foram gerados quatro agrupamentos: entrada moderada, saída fraca, saída moderada e saída forte. O grupo com mais representantes é o de saída forte"
  
  
  str_info_metodologia$texto[10]<- "Conclusões:"
  
  str_info_metodologia$texto[11]<- "Os municípios com menor capacidade de gestão e influência e além disso com menor percentual gasto em atendimento hospitalar e ambulatorial caracterizam os grupos saída moderada e saída forte. Já o grupo entrada moderada é dominado por municípios com maior capacidade de gestão e de influência " 
  
  str_info_metodologia$texto[12]<- "Escreva um texto jornalístico com linguagem de jornalismo local a partir das informações acima, bem como a partir das informações que caracterizam um município escolhido para ser analisado de forma mais específica. Na análise para os dados de município deve-se considerar os dados apresentados nas três seções de dados em formato csv que serão apresentados mais a frente. É importante frisar que os dados que mostram os números absolutos apresentados referem-se a uma amostra de 10% de todos os atendimentos registrados em 2021 no sistema de internação hospitalar (SIH) do Datasus."
  
  
  codigo_muni<-
    busca_codigo_municipio(input$regic_mun_vis)
  
  selecao<-
    dataset_analise %>%
    filter(deslocamento == 1,
           munic_res == codigo_muni) %>% # antes havia esse filtro complementar: ,perc.x>=0,perc.x<=50
    distinct(nome_nivel_hierarquia.x,munic_res, uf.x,perc.x, mun_res_nome.x) %>%
    inner_join(
      agrupamento_municipio_cluster %>%
        rename(munic_res=code_muni)
    ) %>%
    rename(codigo_muni=munic_res)%>% 
    inner_join(
      pop_municipios %>%
        select(id_municipio,
               sigla_uf) %>%
        mutate(codigo_muni=  str_sub(id_municipio,1,6))
    ) %>%
    mutate(uf.x = sigla_uf)  
  
  selecao<-
    selecao %>%
    select(-c(liquido,id_agrupamento)) %>%
    mutate(
      perc_saida = round(perc_saida,2),
      perc_entrada = round(perc_entrada,2),
      cluster_4_k = as.character(cluster_4_k)
    ) %>%
    select(mun_res_nome.x,
           uf.x,
           perc.x,
           nome_nivel_hierarquia.x,
           entrada,
           local,
           saida,
           perc_saida,
           perc_entrada,
           cluster_4_k) 
  
  print(selecao)
  
  
  names(selecao)<-
    c("Municipio",
      "UF",
      "percentual_gasto_em_atendimento_hospitalar",
      "hierarquia_do_REGIC",
      "numero_amostral_de-paciente_vindos_de_outros_municipios",
      "numero_amostral_de_pacientes_da_dade_atendidos_localmente",
      "numero_amostral_pacientes_atendidos_em_outros_municipios",
      "percentual_pacientes_atendidos_em_outra_cidade",
      "percentual_atendimentos_de_pacientes_de_outra cidade",
      "grupo_do_municipio"
    )
  
  str_info_tabela_1<- tibble(texto = "Diagnóstico de oferta e demanda de atendimento para o município:")
  str_names_colunas_tabela_1<- tibble(texto= str_c(names(selecao), collapse = ","))
  
  
  str_df_tabela_1<-
    purrr::map_dfr(1:NROW(selecao), function(num_linha){
      tibble(texto=str_c(selecao[num_linha,], collapse = ","))
    })
  
  
  # codigo_muni<-
  #   unique(dataset_analise$munic_res[dataset_analise$mun_res_nome.x %in% mun_selecionado])
  
  
  
  
  muni_sel<- 
    dataset_analise %>%
    filter(deslocamento ==1,
           munic_res ==	codigo_muni) %>%
    group_by(munic_res,mun_res_nome.x,nome_nivel_hierarquia_ordenado.x, uf.x) %>%
    summarise(quantidade = n()) %>%
    rename(code_muni= munic_res,
           hierarquia = nome_nivel_hierarquia_ordenado.x,
           uf = uf.x) %>%
    mutate(tipo_deslocamento  = "origem",
           distancia = 0) %>%
    bind_rows(
      dataset_analise %>%
        filter(deslocamento ==1,
               munic_res==	codigo_muni) %>%
        group_by(codufmun,mun_res_nome.y, nome_nivel_hierarquia_ordenado.y, uf.y) %>%
        summarise(
          quantidade = n(),
          distancia =min(distancia)
        ) %>%
        ungroup() %>%
        rename(code_muni= codufmun,
               hierarquia = nome_nivel_hierarquia_ordenado.y,
               uf=uf.y)%>%
        mutate(tipo_deslocamento  = "destino")
    ) %>%
    filter(distancia != 0) %>%
    ungroup()%>% 
    inner_join(
      pop_municipios %>%
        select(id_municipio,
               sigla_uf) %>%
        mutate(code_muni=  str_sub(id_municipio,1,6))
    ) %>%
    mutate(uf = sigla_uf,
           perc_paciente_saida = round(quantidade/num_paciente_saida,2)*100) %>%  
    slice_max(quantidade, n= 5) %>%
    mutate(hierarquia = as.character(hierarquia)) %>%
    mutate(hierarquia = ifelse(is.na(hierarquia),"",hierarquia),
           distancia = round(distancia,2)) %>%
    select(
      mun_res_nome.y,
      uf,
      hierarquia, 
      perc_paciente_saida,
      distancia
    )
  
  names(muni_sel)<-
    c("municipio_destino_paciente",
      "uf",
      "hierarquia_regic_municipio_destino",
      paste("percentual_pacientes_deslocados_de_", input$regic_mun_vis),
      "distancia_ao_municipio"
    )
  
  
  
  
  str_info_tabela_2<- tibble(texto = "Cinco destinos mais frequentes dos pacientes do municípios:")
  str_names_colunas_tabela_2<- tibble(texto= str_c(names(muni_sel), collapse = ","))
  
  
  str_df_tabela_2<-
    purrr::map_dfr(1:NROW(muni_sel), function(num_linha){
      tibble(texto=str_c(muni_sel[num_linha,], collapse = ","))
    })
  
  
  info_entrada<- TRUE
  

  if (NROW(unique(dataset_analise$codufmun[dataset_analise$codufmun==codigo_muni])) == 0){
    
    info_entrada<- FALSE
    str_disclaimer <- tibble(texto= "O município não recebeu pacientes de fora")
    
  } else{
    

    print("codigo_muni")
    print(codigo_muni)
    
    
    municipio_selecionado<-codigo_muni
    
    muni_sel<- 
      dataset_analise %>%
      filter(deslocamento ==1,
             codufmun==	municipio_selecionado) %>%
      group_by(codufmun,mun_res_nome.y,nome_nivel_hierarquia_ordenado.y, uf.y) %>%
      summarise(quantidade = n()) %>%
      rename(code_muni= codufmun,
             hierarquia = nome_nivel_hierarquia_ordenado.y,
             uf = uf.y) %>%
      mutate(tipo_deslocamento  = "destino",
             distancia = 0) %>%
      bind_rows(
        dataset_analise %>%
          filter(deslocamento ==1,
                 codufmun==	municipio_selecionado) %>%
          group_by(munic_res,mun_res_nome.x, nome_nivel_hierarquia_ordenado.x, uf.x) %>%
          summarise(
            quantidade = n(),
            distancia =min(distancia)
          ) %>%
          ungroup() %>%
          rename(code_muni= munic_res,
                 hierarquia = nome_nivel_hierarquia_ordenado.x,
                 uf=uf.x)%>%
          mutate(tipo_deslocamento  = "origem")
      )%>%
      filter(distancia != 0) %>%
      ungroup()%>% 
      inner_join(
        pop_municipios %>%
          select(id_municipio,
                 sigla_uf) %>%
          mutate(code_muni=  str_sub(id_municipio,1,6))
      ) %>%
      mutate(uf = sigla_uf,
             perc_paciente_entrada = round(quantidade/num_paciente_entrada,2)*100) %>%
      slice_max(quantidade, n= 5)  %>%
      mutate(hierarquia = as.character(hierarquia)) %>%
      mutate(hierarquia = ifelse(is.na(hierarquia),"",hierarquia),
             distancia = round(distancia,2)) %>%
      select(
        mun_res_nome.x,
        uf,
        hierarquia, 
        perc_paciente_entrada,
        distancia
      )
    
    names(muni_sel)<-
      c("municipio_origem_paciente",
        "uf",
        "hierarquia_regic_municipio_origem",
        paste("percentual_de_pacientes_deslocados_para_",input$regic_mun_vis),
        "distancia_ao_municipio"
      )
    
    str_info_tabela_3<- tibble(texto = "Cinco origens mais frequentes dos pacientes atendidos no município:")
    str_names_colunas_tabela_3<- tibble(texto= str_c(names(muni_sel), collapse = ","))
    
    str_df_tabela_3<-
      purrr::map_dfr(1:NROW(muni_sel), function(num_linha){
        tibble(texto=str_c(muni_sel[num_linha,], collapse = ","))
      })
    
  }
  
  if (info_entrada){
    
    texto_gpt<-
      str_info_metodologia %>%
      bind_rows(str_info_tabela_1,
                str_names_colunas_tabela_1,
                str_df_tabela_1,
                str_info_tabela_2,
                str_names_colunas_tabela_2,
                str_df_tabela_2,
                str_info_tabela_3,
                str_names_colunas_tabela_3,
                str_df_tabela_3)
    
    
  } else{
    texto_gpt<-
      str_info_metodologia %>%
      bind_rows(str_info_tabela_1,
                str_names_colunas_tabela_1,
                str_df_tabela_1,
                str_info_tabela_2,
                str_names_colunas_tabela_2,
                str_df_tabela_2,
                str_disclaimer)
    
  }
  
  
  DT::datatable(
    texto_gpt,
    #class = "",
    rownames = FALSE,
    colnames = c(""),
    fillContainer = TRUE,
    selection = c("none"),
    extensions = 'Buttons',
    options = list(
      ordering=FALSE,
      paging=FALSE,
      searching= FALSE,
      info = FALSE,
      pageLength = NROW(texto_gpt),
      dom = 'Bfrtip',
      buttons = c('copy')
    )
  )
  
  
  
  # HTML(
  #   kable(texto_gpt)
  # )
  
  
})

```

